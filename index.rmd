---
title: "SNSF Budget"
output: 
  flexdashboard::flex_dashboard:
    theme: bootstrap
    social: menu
    source_code: https://git.io/vb2Tv
---

---
title: "Supplementary Figures to a Reply to 10.1073/pnas.1609996114"
output: 
  flexdashboard::flex_dashboard:
    social: [ "menu" ]
    source_code: https://git.io/v7BY8
    theme: bootstrap
    navbar:
      - { title: "NIH Figures", href: "http://www.pnas.org/content/114/25/6498.figures-only", align: right }
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
if (!require(pacman)) install.packages("pacman")
if (!require(janitor)) install.packages("janitor")
p_load(
  "flexdashboard", 
  "networkD3",
  "tidyverse", 
  "lubridate", 
  "stringr", 
  "magrittr", 
  "rio")
YEAR <- 2017
```

### Approved Amounts for SNSF Grants Starting in `r YEAR`

```{r}
time_range <- ymd(c(str_c(YEAR, "-01-01"), str_c(YEAR, "-12-31")))

grants <- read.csv2(
  url("http://p3.snf.ch/P3Export/P3_GrantExport.csv"),
  stringsAsFactors = FALSE) %>% 
  janitor::clean_names() %>%
  select(funding_instrument_hierarchy,
         discipline_number,
         university,
         approved_amount, 
         start_date) %>%
  mutate(start_date = dmy(start_date)) %>%  
  filter(between(start_date, time_range[1], time_range[2])) %>%
  select(-start_date) %>%
  mutate( # clean intrument names
    instrument = str_replace(funding_instrument_hierarchy, "^$", "Miscellaneous"),
    instrument = str_replace(instrument, "(.*)[Ff]ellowships", "Fellowships"),
    instrument = str_replace(instrument, "(.*)NRPs(.*)", "NRPs"),
    instrument = str_replace(instrument, "(.*)r4d(.*)", "r4d"),
    instrument = str_c(instrument, " ")) %>%
  mutate( # clean institution names
    institution = str_replace(university, "^$", "Others"),
    institution = str_replace(institution, "(.*)[[:space:]][-][[:space:]]", ""),
    institution = str_replace(institution, "IACH", "International"),
    institution = str_c(institution, " ")) %>%
  mutate(approved_amount = as.numeric(approved_amount)) # introduces NAs

institutions <- count(grants, institution) %>%
  mutate(uni = ifelse(n > 10, institution, "Others"))

grants <- grants %>%
  left_join(institutions, by = "institution") %>%
  select(approved_amount, instrument, uni)

nodes <- tibble(
  name = c(
    sort(unique(grants$instrument)),
    sort(unique(grants$uni)))) %>%
  rowid_to_column("id") %>%
  mutate(id = id - 1)

links <- grants %>%
  group_by(instrument, uni) %>%
  summarise(value = sum(approved_amount)) %>%
  ungroup() %>%
  left_join(nodes, by = c("instrument" = "name")) %>%
  rename("source" = id) %>%
  left_join(nodes, by = c("uni" = "name")) %>%
  rename("target" = id) %>%
  select(source, target, value)

nodes <- nodes %>% select(-id) %>%
  as.data.frame(stringsAsFactors = FALSE)
  
links <- links %>%
  mutate(source = as.integer(source),
         target = as.integer(target)) %>%
  as.data.frame(stringsAsFactors = FALSE)

sankeyNetwork(
  Links = links, Nodes = nodes, 
  Source = "source", Target = "target", Value = "value", NodeID = "name",
  units = "CHF", fontSize = 12, nodeWidth = 30)

```

> Credits: [flexdashboard](https://github.com/rstudio/flexdashboard), [networkD3](https://christophergandrud.github.io/networkD3/). Data: [SNSF P3_GrantExport.csv](http://p3.snf.ch/Pages/DataAndDocumentation.aspx). Last updated: `r Sys.time()`.

